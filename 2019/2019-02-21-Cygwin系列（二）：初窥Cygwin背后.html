<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录分享Cygwin、Linux、编程等计算机技术"><title>Cygwin系列（二）：初窥Cygwin背后 | silaoA的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Cygwin系列（二）：初窥Cygwin背后</h1><a id="logo" href="/.">silaoA的博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Cygwin系列（二）：初窥Cygwin背后</h1><div class="post-meta">Feb 21, 2019<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-前言：跨平台移植实现"><span class="toc-text">0x00 前言：跨平台移植实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#编写过程"><span class="toc-text">编写过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译链接过程"><span class="toc-text">编译链接过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载过程"><span class="toc-text">加载过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-Cygwin是怎么做到的？"><span class="toc-text">0x01 Cygwin是怎么做到的？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-Cygwin随后的发展"><span class="toc-text">0x02 Cygwin随后的发展</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>本文共2200余字，预计阅读时间9分钟，本文同步发布于知乎（账号silaoA）和微信公众号平台（账号伪码人）。<br>关注学习了解更多的Cygwin、Linux技术。</p>
<p>本篇接上篇<a href="2019-02-14-Cygwin系列（一）：Cygwin是什么.html">Cygwin系列（一）：Cygwin是什么</a>介绍Cygwin背后实现的思路。</p>
<a id="more"></a>
<!-- [toc] -->
<h1 id="0x00-前言：跨平台移植实现"><a href="#0x00-前言：跨平台移植实现" class="headerlink" title="0x00 前言：跨平台移植实现"></a>0x00 前言：跨平台移植实现</h1><p>一个程序软件从诞生到运行起来，粗略地分，要经历以下几个过程：<br>①　编写源代码；<br>②　源代码编译、链接；<br>③　系统加载程序文件；<br><img src="../pic/程序软件从诞生到运行.png" alt="程序软件从诞生到运行"><br>3个阶段的主导角色分别是：文本编辑器（Editor）、编译工具链（Tool chain，链的意思是一系列工具而不止一个）、程序加载器（Loader）。要实现跨平台移植，就要从这三方面入手。</p>
<h2 id="编写过程"><a href="#编写过程" class="headerlink" title="编写过程"></a>编写过程</h2><p>源代码是纯文本，在不同的系统平台（如Windows、UNIX、Linux）差异除了换行符其他可以忽略不计，而且文本编辑器通常也能设定换行符，再退一步，还有工具实现文本中换行符的转换。可以认为，源代码编写过程在不同系统平台没有差异。</p>
<h2 id="编译链接过程"><a href="#编译链接过程" class="headerlink" title="编译链接过程"></a>编译链接过程</h2><p>程序源代码文件经过编译汇编生成二进制的目标文件，目标文件就包含了机器指令、数据等内容，目标文件再与必要的库文件链接最终形成可执行文件。<br><img src="../pic/编译链接过程示意.png" alt="编译链接过程示意图"><br>不同的系统平台（如Windows、UNIX、Linux）上目标文件、可执行文件格式是不同的，库文件是已有目标的归档包（archive），不同的系统平台所拥有的库文件（比如<a href="2019-02-14-Cygwin系列（一）：Cygwin是什么.html">Cygwin系列（一）：Cygwin是什么</a>中所提到的C标准库）也是不一样的。</p>
<p><strong>一言以蔽之，系统A上的目标文件、库文件、可执行文件在系统B上一般是不可直接识别的；如果他们能做到相互识别，那可称这两个系统ABI（Application Binary Interface，应用程序二进制接口）兼容。</strong></p>
<h2 id="加载过程"><a href="#加载过程" class="headerlink" title="加载过程"></a>加载过程</h2><p>os内核创建一个新的进程，装载器，或者叫加载器，在内存开辟一片区域，从外部存储空间（如磁盘）中复制可执行文件内容到内存相关的段（segment）中，再跳转到程序入口并执行。</p>
<p>不同的系统平台（如Windows、UNIX、Linux）加载过程大致类似，但细节上有诸多不同。</p>
<p>此外，上述过程中的编译工具链（Tool chain）、程序加载器（Loader），这些程序本身在不同的系统平台也是不一样的。</p>
<h1 id="0x01-Cygwin是怎么做到的？"><a href="#0x01-Cygwin是怎么做到的？" class="headerlink" title="0x01 Cygwin是怎么做到的？"></a>0x01 Cygwin是怎么做到的？</h1><p>1995年，Windows已经启用Windows NT内核、发布Windows 95并获得了巨大的成功。另一头，Linux发行版如Slackware、Debian、Red Hat，UNIX-like发行版如4.4BSD、FreeBSD等也都拥有了众多的用户。UNIX和Linux是近亲，在API层面兼容（由POSIX标准保证），而Windows与UNIX/Linux是API、ABI均不兼容。如果程序能够在不同操作系统上运行，那便能大大丰富软件生态。<br><img src="../pic/Windows、Linux发行版.png" alt="Windows、Linux发行版和FreeBSD（图片来源于网络）"></p>
<p>Cygwin取巧的步骤是上图的<strong>编译链接过程</strong>。</p>
<p>1995年，Cygnus Solutions公司的工程师注意到Windows NT和Windows 95的目标文件使用COFF格式，Windows系统的可执行文件格式PE（Portable Executable）和Linux系统的可执行文件格式ELF（Executable Linkable Format）都是COFF的变种，而且此时GNU项目的gcc编译工具链已经支持COFF格式和newlib C标准库。</p>
<p>这位工程师灵光一闪，可否改造gcc编译工具链产生一个交叉工具链，进而能够生成Windows系统原生的目标文件和可执行文件呢？得益于gcc良好的跨平台支持特性，这项工作很快就完成了，这个 <strong>“交叉”版的gcc</strong>运行于Linux系统，但生成Windows系统的目标文件，正因运行系统（host）和目标系统（target）不同，所以它才叫“交叉”工具链。<br><img src="../pic/第一步：制作交叉版gcc工具链.png" alt="第一步：制作交叉版gcc工具链"></p>
<p>接下来，第二项重要工作，是要把这个“改造”版的gcc进一步改造，使其能够运行在Windows系统上。要让这个Windows版的gcc真正运行起来，还依赖于bash、POSIX兼容的系统调用等等系列程序和环境，一种思路是把这些依赖程序使用Win32 API重写、再编译构建，但这要花大量的时间将每一个程序都重写。</p>
<p>Cygnus Solutions公司放弃了这种思路，干脆使用Win32 API重写一个函数库（Cygwin DLL），提供Win32 API所缺少的必要的POSIX API，如fork、spawn、signals、select、sockets等，事实上Cygwin DLL还调用了部分Windows Native API，并且<strong>由于os设计理念上的差异，以及Windows中有大量未对外公开的Win32 API、Windows Native API，有些POSIX API根本无法用它们模拟，Cygnus Solutions公司只能完全从零重写，而且为了处理POSIX和Windows中的差异还写了一部分Cygwin专有的函数。</strong>再进一步，将相关程序链接到此DLL，交叉编译出Win32版的bash等依赖程序以及libc等函数库。<br><img src="../pic/第二步：生成Win32版Cygwin&#32;DLL和必要工具.png" alt="第二步：生成Win32版Cygwin DLL和必要工具"></p>
<p>现在，兼容PSOIX的模拟层、构建gcc所依赖的bash等工具都已齐备，“改造”版的gcc移植到Windows系统几乎是水到渠成的事情了。<br><img src="../pic/第三步：移植gcc工具链到Windows.png" alt="第三步：移植gcc工具链到Windows"></p>
<p>至此，兼容PSOIX的模拟层以及基于此模拟层的bash、gcc编译工具链、函数库等所组成的开发工具集已能在Windows 95/NT系统上运行起来。紧接着，Cygnus Solutions公司改写配置脚本，逐步把众多GNU、BSD及其他自由软件都移植到Windows 95/NT系统上，并按照UNIX/Linux的目录树架构组织存放，使得Cygwin环境越来越完备，UNIX系统上标准工具在Cygwin中都有了可用的版本。到1996年10月，Cygwin已完全自足，发布17.1 beta版。</p>
<h1 id="0x02-Cygwin随后的发展"><a href="#0x02-Cygwin随后的发展" class="headerlink" title="0x02 Cygwin随后的发展"></a>0x02 Cygwin随后的发展</h1><p>整个Cygwin工具集开始是作为一个单独的安装包提供，到2000年4月，项目宣布了新的发布方式，额外提供一个不依赖于Cygwin的Windows原生程序——<code>setup.exe</code>，具有图形界面，用于安装、更新、卸载软件包，因此可视为Cygwin软件包管理器，此后<code>setup.exe</code>和<code>Cygwin DLL</code>分别独立开发。</p>
<p>2009年Cygwin DLL v1.7发布，抛弃了对老版本Windows（Windows 95/98/Me）的支持，充分利用Windows NT的新特性，如文件名大小写敏感、IPv6支持等。随后，Cygwin DLL、setup.exe都有了64位版本。Cygwin软件包按照用途分类组织，方便管理。Cygwin项目还提供了一系列系统工具，如<code>cygpath</code>、<code>cygrunsrv</code>、<code>cygcheek</code>、<code>cygstart</code>等，以便更好地操作管理Windows系统。</p>
<p>越来越多的开发者也加入了Cygwin项目，帮助将GNU、BSD及其他自由软件移植到Cygwin并打包。越来越多的机构、公司将Cygwin官方的软件仓库同步镜像过来，由此在世界各地形成众多Cygwin镜像站点，共世界各地的用户下载Cygwin的软件包，中国的比如网易、阿里、清华、中科大、华科等均提供Cygwin镜像站。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.cygwin.com" target="_blank" rel="noopener">http://www.cygwin.com</a></li>
<li><a href="http://en.wikipedia.org/wiki/Cygwin" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Cygwin</a></li>
<li><a href="https://en.wikipedia.org/wiki/Linux_kernel_interfaces" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Linux_kernel_interfaces</a></li>
<li>俞甲子，石凡，潘爱民·程序员的自我修养——链接、装载与库[M]·电子工业出版社，2009·</li>
</ul>
<hr>
<p><strong>如本文对你有帮助，或内容引起极度舒适，欢迎分享转发或点击下方捐赠按钮打赏</strong> ^_^</p>
</div><iframe src="/donate/?AliPayQR=/pic/AliPayQR.jpg&amp;WeChatQR=/pic/WeChatQR.png&amp;GitHub=https://github.com/Kaiyuan/donate-page&amp;BTCQR=undefined&amp;BTCKEY=undefined&amp;PayPal=undefined" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>silaoA</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/2019-02-21-Cygwin系列（二）：初窥Cygwin背后.html">https://silaoa.github.io/2019/2019-02-21-Cygwin系列（二）：初窥Cygwin背后.html</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为原创文章，如需转载，请联系stsilaoa@gmail.com 或 公众号 伪码人 或知乎私信 silaoA。</li></ul></div><br><div class="tags"><a href="/tags/Cygwin/">Cygwin</a><a href="/tags/Linux/">Linux</a><a href="/tags/Windows/">Windows</a></div><div class="post-nav"><a class="pre" href="/2019/2019-02-26-Cygwin系列（三）：盘点与Cygwin相似和相反的项目.html">Cygwin系列（三）：盘点与Cygwin相似和相反的项目</a><a class="next" href="/2019/2019-02-14-Cygwin系列（一）：Cygwin是什么.html">Cygwin系列（一）：Cygwin是什么</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://silaoa.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">23</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/Cygwin/" style="font-size: 15px;">Cygwin</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/IEEE/" style="font-size: 15px;">IEEE</a> <a href="/tags/机器人/" style="font-size: 15px;">机器人</a> <a href="/tags/科技/" style="font-size: 15px;">科技</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/WSL/" style="font-size: 15px;">WSL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/2019-12-20-Python操作Excel文件（3）：优雅干将openpyxl.html">Python操作Excel文件（3）：优雅干将openpyxl</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-12-16-Python操作Excel文件（2）：中规中矩三兄弟xlrd、xlwt和xlutils.html">Python操作Excel文件（2）：中规中矩三兄弟xlrd、xlwt和xlutils</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-12-10-Python操作Excel文件（1）：花式大师pyexcel.html">Python操作Excel文件（1）：花式大师pyexcel</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-12-03-Python操作Excel文件（0）：盘点.html">Python操作Excel文件（0）：盘点</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-08-28-安装Windows7排除USB3驱动缺失问题的经历.html">安装Windows7排除USB3驱动缺失问题的经历</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-08-15-Python项目如何合理组织规避import天坑.html">Python项目如何合理组织规避import天坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-06-16-Cygwin系列（九）：Cygwin学习路线.html">Cygwin系列（九）：Cygwin学习路线</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-05-25-Cygwin系列（八）：命令行软件包管理器apt-cyg.html">Cygwin系列（八）：命令行软件包管理器apt-cyg</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-05-12-Cygwin系列（七）：Cygwin软件包管理相关配置.html">Cygwin系列（七）：Cygwin软件包管理相关配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/2019-05-08-微软WSL——Linux桌面未来之光.html">微软WSL——Linux桌面版未来之光</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://silaoa.github.io" title="silaoA的网络日志" target="_blank">silaoA的网络日志</a><ul></ul><a href="http://www.zhihu.com/people/laoa-si/posts" title="silaoA的知乎文章" target="_blank">silaoA的知乎文章</a><ul></ul><a title="微信公众号：伪码人（We_Coder）" target="_blank">微信公众号：伪码人（We_Coder）</a><ul></ul><a title="QQ交流群：374791536" target="_blank">QQ交流群：374791536</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">silaoA的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>